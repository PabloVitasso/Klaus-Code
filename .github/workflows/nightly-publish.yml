name: Nightly Publish

on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering.

jobs:
  publish-nightly:
    runs-on: ubuntu-latest

    permissions:
      contents: write # Required for creating releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install-args: '--frozen-lockfile'
      - name: Cache Turbo build artifacts
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-
      - name: Forge numeric Nightly version
        id: version
        env:
          RUN_NUMBER: ${{ github.run_number }}
        run: echo "number=$(( 5500 + ${RUN_NUMBER} ))" >> $GITHUB_OUTPUT
      - name: Patch package.json version
        env:
          VERSION_NUMBER: ${{ steps.version.outputs.number }}
        run: |
          node <<'EOF'
            const fs = require('fs');
            const path = require('path');
            const pkgPath = path.join(__dirname, 'apps', 'vscode-nightly', 'package.nightly.json');
            const pkg = JSON.parse(fs.readFileSync(pkgPath,'utf8'));
            const [maj, min] = pkg.version.split('.');
            pkg.version = `${maj}.${min}.${process.env.VERSION_NUMBER}`;
            fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));
            console.log(`ðŸ”– Nightly version set to ${pkg.version}`);
          EOF
      - name: Build dependencies
        run: pnpm build
      - name: Build VSIX
        run: pnpm vsix:nightly # Produces bin/klaus-code-nightly-0.0.[count].vsix
      - name: Create GitHub Pre-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NIGHTLY_VERSION="0.0.${{ steps.version.outputs.number }}"
          VSIX_FILE=$(ls bin/*.vsix | head -n1)
          VSIX_FILENAME=$(basename "$VSIX_FILE")

          # Create pre-release with the VSIX
          gh release create "nightly-v${NIGHTLY_VERSION}" \
            --title "Nightly Build v${NIGHTLY_VERSION}" \
            --notes "Automated nightly build from commit ${{ github.sha }}" \
            --prerelease \
            "$VSIX_FILE"

          echo "Created nightly pre-release v${NIGHTLY_VERSION} with ${VSIX_FILENAME}"
      # - name: Publish to VS Code Marketplace
      #   env:
      #     VSCE_PAT: ${{ secrets.VSCE_PAT }}
      #   run: npx vsce publish --packagePath "bin/$(/bin/ls bin | head -n1)"
      # - name: Publish to Open VSX Registry
      #   env:
      #     OVSX_PAT: ${{ secrets.OVSX_PAT }}
      #   run: npx ovsx publish "bin/$(ls bin | head -n1)"
